<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chronex | Authentication</title>
    <link rel="stylesheet" href="css/index/style.css">
</head>
<body>

<div class="container">
    <h1>Chronex</h1>
    <p class="tagline" id="subtitle">Login to your account</p>

    <input type="email" id="email" placeholder="Email ID">
    <input type="password" id="password" placeholder="Password">

    <button id="mainBtn" onclick="handleAction()">Login</button>

    <div class="divider">
        <span>Or continue with</span>
    </div>

    <button class="google-btn" onclick="googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        <span>Google</span>
    </button>

    <p class="switch">
        <span id="switchText">Don't have an account?</span>
        <a href="#" onclick="toggleMode()">Sign up</a>
    </p>

    <p id="msg"></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // üîß Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA_Za7Bjbob5zFGZxN5Q2TikIHAoPdb0Uc",
    authDomain: "chronex-2b57e.firebaseapp.com",
    projectId: "chronex-2b57e",
    appId: "1:588027762022:web:f6cfef49299c8116c5a4a7"
  };

  // üî• Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let mode = "login";

  // üîÅ Toggle login / signup
  window.toggleMode = function () {
    const mainBtn = document.getElementById("mainBtn");
    const subtitle = document.getElementById("subtitle");
    const switchText = document.getElementById("switchText");
    const msg = document.getElementById("msg");

    msg.innerText = "";

    if (mode === "login") {
      mode = "signup";
      mainBtn.innerText = "Sign Up";
      subtitle.innerText = "Create your Chronex account";
      switchText.innerText = "Already have an account?";
      document.querySelector(".switch a").innerText = "Login";
    } else {
      mode = "login";
      mainBtn.innerText = "Login";
      subtitle.innerText = "Login to your account";
      switchText.innerText = "Don't have an account?";
      document.querySelector(".switch a").innerText = "Sign up";
    }
  };

  // üß† Ensure Firestore user profile exists
  async function ensureUserProfile(user) {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
      await setDoc(userRef, {
        uid: user.uid,
        email: user.email,
        name: user.displayName || "",
        photoURL: user.photoURL || "",
        createdAt: serverTimestamp()
      });
    }
  }

  // üìß Email / Password Auth
  window.handleAction = async function () {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const msg = document.getElementById("msg");

    if (!email || !password) {
      msg.innerText = "Please fill all fields";
      msg.style.color = "red";
      return;
    }

    try {
      const result =
        mode === "login"
          ? await signInWithEmailAndPassword(auth, email, password)
          : await createUserWithEmailAndPassword(auth, email, password);

      await ensureUserProfile(result.user);
      window.location.href = "home.html";

    } catch (err) {
      msg.innerText = err.message;
      msg.style.color = "red";
    }
  };

  // üîê Google Login
  window.googleLogin = async function () {
    const msg = document.getElementById("msg");

    try {
      const result = await signInWithPopup(auth, provider);
      await ensureUserProfile(result.user);
      window.location.href = "home.html";

    } catch (error) {
      msg.innerText = error.message;
      msg.style.color = "red";
    }
  };
</script>

</body>
</html>
