<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chronex | Dashboard</title>

    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="css/home/layout.css">
    <link rel="stylesheet" href="css/home/sidebar.css">
    <link rel="stylesheet" href="css/dashboard/cards.css">
    <link rel="stylesheet" href="css/placeholder/placeholder.css">
</head>
<body>

<!-- ================= HEADER ================= -->
<header class="top-header">
    <div class="left-section">
        <div class="menu-icon" onclick="toggleMenu()">â˜°</div>
        <img src="logo.png" alt="Chronex Logo" class="logo">
    </div>

    <div class="search-container">
        <svg class="search-icon" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="16.5" y1="16.5" x2="22" y2="22"></line>
        </svg>
        <input class="search-bar" placeholder="Search tasks or meetings...">
    </div>

    <div class="header-right">
        <div id="userAvatar" class="user-avatar" onclick="toggleUserMenu()">U</div>

        <div id="userMenu" class="user-menu">
            <div class="user-menu-item">Profile</div>
            <div class="user-menu-item">Settings</div>
            <div class="user-menu-item logout" onclick="logout()">Log Out</div>
        </div>
    </div>
</header>

<!-- ================= CONTENT ================= -->
<div class="content-wrapper">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar open">
        <ul class="sidebar-links">
            <li class="active" data-page="dashboard">Dashboard</li>
            <li data-page="tasks">My Tasks</li>
            <li data-page="meetings">Meetings</li>
            <li data-page="analytics">Time Analytics</li>
            <li data-page="organization">Organization</li>
            <li data-page="reports">Reports</li>
        </ul>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <div id="page-content"></div>
    </main>

</div>

<!-- ================= UI SCRIPT ================= -->
<script>
function getRandomColor() {
    const colors = [
        "linear-gradient(135deg, #22d3ee, #3b82f6)",
        "linear-gradient(135deg, #6366f1, #3b82f6)",
        "linear-gradient(135deg, #a855f7, #6366f1)",
        "linear-gradient(135deg, #06b6d4, #22d3ee)",
        "linear-gradient(135deg, #0ea5e9, #2563eb)"
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

function toggleUserMenu() {
    const menu = document.getElementById("userMenu");
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
}

document.addEventListener("click", (e) => {
    const avatar = document.getElementById("userAvatar");
    const menu = document.getElementById("userMenu");
    if (!avatar.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = "none";
    }
});

function toggleMenu() {
    document.getElementById("sidebar").classList.toggle("open");
}

const sidebarItems = document.querySelectorAll(".sidebar-links li");
const pageContent = document.getElementById("page-content");

sidebarItems.forEach(item => {
    item.addEventListener("click", () => {
        sidebarItems.forEach(li => li.classList.remove("active"));
        item.classList.add("active");
        loadPage(item.dataset.page);
    });
});

function loadPage(page) {
    fetch(`partials/${page}.html`)
        .then(res => res.text())
        .then(html => pageContent.innerHTML = html)
        .catch(() => pageContent.innerHTML = "<p>Error loading page</p>");
}

loadPage("dashboard");
</script>

<!-- ================= FIREBASE AUTH ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// ðŸ”§ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA_Za7Bjbob5zFGZxN5Q2TikIHAoPdb0Uc",
  authDomain: "chronex-2b57e.firebaseapp.com",
  projectId: "chronex-2b57e",
  appId: "1:588027762022:web:f6cfef49299c8116c5a4a7"
};

// ðŸ”¥ Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ðŸ” Protect page + load Firestore user profile
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
      const data = snap.data();
      const avatar = document.getElementById("userAvatar");

      // If Google photo exists â†’ show image
      if (data.photoURL) {
        avatar.style.backgroundImage = `url(${data.photoURL})`;
        avatar.style.backgroundSize = "cover";
        avatar.style.backgroundPosition = "center";
        avatar.textContent = "";
      } 
      // Else â†’ show initial
      else {
        avatar.textContent = (data.name || data.email)[0].toUpperCase();
        avatar.style.background = getRandomColor();
      }
    }
  } catch (err) {
    console.error("Failed to load user profile:", err);
  }
});

// ðŸ”“ Logout
window.logout = function () {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
};
</script>

</body>
</html>
